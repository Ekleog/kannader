<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>kannader</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">1.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">1.1.</strong> High-Level Architecture Overview</a></li><li class="chapter-item expanded "><a href="configuration_format.html"><strong aria-hidden="true">1.2.</strong> Configuration Format</a></li><li class="chapter-item expanded "><a href="security.html"><strong aria-hidden="true">1.3.</strong> Security</a></li><li class="chapter-item expanded "><a href="simplicity.html"><strong aria-hidden="true">1.4.</strong> Simplicity</a></li><li class="chapter-item expanded "><a href="queue_internals.html"><strong aria-hidden="true">1.5.</strong> How The Queue Works</a></li></ol></li><li class="chapter-item expanded "><a href="community.html"><strong aria-hidden="true">2.</strong> Community</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">kannader</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/Ekleog/kannader" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="design"><a class="header" href="#design">Design</a></h1>
<p>This section is about the design of kannader, some parts internal as
well as some that may have an impact on regular use cases. Nothing
here should be required for properly configuring a kannader instance,
but it should help understanding why some design choices were made.</p>
<p>If you find something of practical impact that is not well-explained
enough in the rest of the book, and had to resort to this section to
properly use kannader, this is a documentation issue — please open an
issue about that!</p>
<p>And, on the other hand, if there is an aspect of the design of
kannader that you do not understand, it probably should have an answer
in this section.</p>
<h2 id="guiding-principles"><a class="header" href="#guiding-principles">Guiding Principles</a></h2>
<ul>
<li>Security</li>
<li>Simplicity</li>
<li>Flexible Configuration</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="high-level-architecture-overview"><a class="header" href="#high-level-architecture-overview">High-Level Architecture Overview</a></h1>
<h2 id="code-layout"><a class="header" href="#code-layout">Code layout</a></h2>
<ul>
<li>
<p><a href="https://ekleog.github.io/kannader/dev-doc/smtp_message/index.html"><code>smtp-message</code></a>
handles the SMTP protocol, at the parsing and serialization level.</p>
</li>
<li>
<p><a href="https://ekleog.github.io/kannader/dev-doc/smtp_server/index.html"><code>smtp-server</code></a>
exposes an <code>interact</code> function, that semantically takes in a
configuration and a client with which it's going to interact, and
handles the SMTP interaction with this single client.</p>
</li>
<li>
<p><a href="https://ekleog.github.io/kannader/dev-doc/smtp_queue/index.html"><code>smtp-queue</code></a>
runs a queue for use by SMTP servers, delegating to a storage handler
and a transport for sending messages that have reached their scheduled
time for sending.</p>
</li>
<li>
<p><a href="https://ekleog.github.io/kannader/dev-doc/smtp_queue_fs/index.html"><code>smtp-queue-fs</code></a>
implements a storage handler for <code>smtp-queue</code> that relies on the
filesystem.</p>
</li>
</ul>
<h3 id="not-yet-implemented"><a class="header" href="#not-yet-implemented">Not yet implemented</a></h3>
<ul>
<li>
<p><code>smtp-client</code> relays emails to external email servers.</p>
</li>
<li>
<p><code>kannader</code> exposes the API of all above crates to consumers an an
more opinionated way.</p>
</li>
<li>
<p><code>kannader-bin</code> interacts with API with hooks, so that changing the
configuration does not require rebuilding the whole server — see <a href="./configuration_format.html">the
configuration format chapter</a> for more
details</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration-format"><a class="header" href="#configuration-format">Configuration Format</a></h1>
<p>Kannader's distinctive feature is its configuration format. The
objective is to have the configuration be as flexible and fast as
could be, yet be easily usable for users with simple needs.</p>
<p>Fear ye not! These two objectives are not contradictory. The idea for
a solution handling these two use cases is to first build a flexible
and fast configuration format. Once this is done, it then becomes
possible to write wrappers around this configuration format that
expose its flexibility in an easy-to-use format.</p>
<h2 id="flexibility"><a class="header" href="#flexibility">Flexibility</a></h2>
<p>The first and foremost property we need for kannader's configuration
format is flexibility. It is flexibility that will allow kannader to
be usable in most contexts, and it is the one that will be built on to
provide easy-to-use configuration formats.</p>
<p>As a consequence, it is the one on which no compromise is possible.</p>
<p>For maximal flexibility, kannader is designed as a set of
libraries. However, libraries are not what a system administrator
wants to have to manage. As a consequence, a more configuration-y
configuration format is required.</p>
<p>This configuration format consists, basically, in hooks to the
behavior of kannader. Every place a hook could be used for doing
something reasonably useful, a hook should be available.</p>
<h2 id="performance"><a class="header" href="#performance">Performance</a></h2>
<p>Once we have hooks everywhere, a problem quickly arises:
performance. If hooks are used everywhere, then hooks <em>must</em> be
performant. Would that not be the case, the whole server would be
slowed down.</p>
<p>Performant hooks are usually written in Lua. This is what was
considered in the first design of kannader's configuration format.</p>
<p>However, Lua has some big issues: the only good implementations that
exist are all written in C, and running such code unsandboxed would go
against kannader's safety motto. It would be surprising if not a
single security flaw was present in Lua<sup class="footnote-reference"><a href="#security">1</a></sup>. Another major
issue of Lua is its being exotic. While other programs, like rspamd or
nginx, already use or allow Lua scripting, system administrators
usually are not fluent in Lua.</p>
<p>This led to searching for another option. Thus arose the idea of
sandboxing a Lua VM: it is possible to run any kind of interpreter
from within a sandbox. And a sandbox mechanism that recently gained
quite a lot of traction is WebAssembly (thereafter abbreviated wasm).</p>
<p>Wasm is <em>fast</em>. Wasm provides a sandbox. Wasm interpreters are
designed for safety, as they run untrusted code found anywhere on the
Internet.</p>
<p>Wasm thus is the choice of predilection for writing the hooks: it's
extremely fast, yet allows for near-perfect configurability.</p>
<h2 id="ease-of-use"><a class="header" href="#ease-of-use">Ease of use</a></h2>
<p>The one thing that wasm gets really, really wrong, among our
requirements, is ease of use. Yet, it is maybe one of our most
important objectives with kannader's configuration format: to provide
a configurable, <em>yet easy</em> configuration format.</p>
<p>This can thankfully be worked around, by using “wrappers.” These take
the configurability of the wasm hooks, and turn it into an easy-to-use
format.</p>
<p>These “wrappers” are, in fact, only pre-compiled wasm blobs that are
provided alongside kannader. They provide configuration formats that
vary in ease-of-use and configurability, allowing to adjust the knob
between the two.</p>
<p>Kannader, being passed a wasm configuration blob at startup (as well
as a list of which local and remote resources should be made available
to the sandbox), can thus simply provide pre-built wasm configuration
blobs that then parse and enforce a specific configuration format.</p>
<h2 id="configuration-blob-examples"><a class="header" href="#configuration-blob-examples">Configuration blob examples</a></h2>
<p>An example of what such configuration blobs could do would be to read
a format that mimicks OpenSMTPD's configuration format, and then
translates it into the appropriate kannader hooks, for easy migration.
This takes a “regular” previously-existing SMTP server's configuration
file, and turns it into a kannader configuration.</p>
<p>But more interesting things can be done with this scheme. For
instance, it is possible to have the wasm configuration blob read a
Lua file, and then run it through a Lua interpreter, thus making the
total flexibility available to the end-user like direct Lua hooks
would have done, to the expense of some performance by running the Lua
VM<sup class="footnote-reference"><a href="#overhead">2</a></sup>.</p>
<p>Or, another wasm configuration blob could read a Python file, and run
it through MicroPython<sup class="footnote-reference"><a href="#python">3</a></sup>. This provides a language that will
probably be more familiar to the sysadmin, yet usable for most
non-maximal-performance use cases.</p>
<p>But it is possible to do more than just have configuration blobs that
read a generic configuration file and converts it into kannader hooks.
It is also possible to have the choice of the configuration blob
itself <em>be</em> part of the configuration. For instance, a configuration
blob could handle the “local server with local users only” use case,
that would setup authentication for all sending that's not directed
towards local users (using callbacks provided by eg. MicroPython code
for things like knowing whether a user is local), antispam and
antivirus if configured to do so, and maybe even automatically
validate the <code>From:</code> header if configured to.</p>
<p>This is a case of encoding domain-specific knowledge in the
configuration blob, in order to make it much easier to write. It
includes almost no flexibility, but should make the configuration as
simple to write as possible.</p>
<div class="footnote-definition" id="security"><sup class="footnote-definition-label">1</sup>
<p>Or in the configuration Lua code, vulnerability that the
attacker could then exploit over the network, with this issue being
more likely the less the configuration code is sandboxed.</p>
</div>
<div class="footnote-definition" id="overhead"><sup class="footnote-definition-label">2</sup>
<p>The wasm sandbox's overhead is probably lower than
LuaJIT's sandbox's overhead, while providing much better security,
which makes it a tool of choice for flexibility and performance.
However, the fact that LuaJIT is most likely very far from being
available on wasm does mean that only a non-JIT version of a Lua VM
can be run on top of wasm… which implies that Lua interpretation will
be much slower. However, this should hopefully not be a problem, as
for all non-intensive use cases the time spent in hooks will probably
not be a concern, and intensive use cases whose use case is not
covered by an existing configuration blob will probably write and
compile their own.</p>
</div>
<div class="footnote-definition" id="python"><sup class="footnote-definition-label">3</sup>
<p>While it may appear surprising to suggest MicroPython
insted of a regular CPython instance, this is based on the fact that
kannader needs to have one interpreter instance per message in flight,
to make sure there is no interference between two messages. As such,
the CPython resident memory size would probably be prohibitive for use
cases that see a high number of emails flow through. Use cases that
only handle few emails would probably work well with CPython, but, the
differences between CPython and MicroPython not being that important
for something that after all is nothing but a configuration format,
MicroPython will probably be a better choice.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="security"><a class="header" href="#security">Security</a></h1>
<h2 id="no-high-privilege---no-root"><a class="header" href="#no-high-privilege---no-root">No high privilege - no root</a></h2>
<p>For historical reasons smtpd servers required root privilege to run. This
necessity was explained by several things:</p>
<ul>
<li>
<p>the ability to use TCP port 25 on Unix-like systems requires root privilege.
(on modern Linux at least <code>CAP_NET_BIND_SERVICE</code> capability is required)</p>
</li>
<li>
<p>the ability to ignore DAC and write mail to user's directory requries root
(<code>CAP_CHOWN</code> and <code>CAP_DAC_OVERRIDE</code>)</p>
</li>
<li>
<p>amusingly, the ability to drop privilege requires root too.
(to employ privilege separation techniques, e.g. spawn child
processes and set their UID and GID to a non-privileged user, root or <code>CAP_SETUID</code>
and <code>CAP_SETGID</code> capabilities are needed)</p>
</li>
</ul>
<p>But all of the above are rudiments of the past.</p>
<blockquote>
<p>It is no longer a catastrophe if an unprivileged process binds to transport
layer ports less than 1024. Everyone should consider reading and writing the
network medium as unlimited due to hardware no longer costing a million
dollars, regardless of what an operating system does.</p>
</blockquote>
<p><a href="http://www.fixup.fi/misc/usenix-login-2015/login_oct15_02_kantee.pdf">Rise and Fall of the Operating System</a></p>
<p>The very action of opening TCP port 25 can be delegated to a very small
privileged program or OS service manager. OS service managers run with root
privilege anyway. The SMTP server can accept the passed descriptor and use it
without ever having to escalate privilege.</p>
<p>Nowadays people are do not usually login to their mail server via ssh to check their mail.
Modern mail servers are running MDAs like Dovecot to present an IMAP interface
to the user. Very likely the mail itself is stored in a virtual mailboxes, owned
by one user (usually <code>vmail</code>)</p>
<p>This practically obsoletes the necessity to support mbox or Maildir in the SMTP
server. Accepted mail can be handed over to MDA via LMTP or piped into another
executable.</p>
<p>One might argue that privilege separation is still necessary to ensure security
and separation of concerns (even Rust might have vulnerabilities discovered in
the future). But this also can be delegated to the OS's service managers - it
is a tool that is designed to orchestrate processes.</p>
<p>All this makes it possible to run the SMTP server as a non-privileged user (or set of
non-privileged users)</p>
<h2 id="safe-programming-language---rust"><a class="header" href="#safe-programming-language---rust">Safe Programming Language - Rust</a></h2>
<h2 id="deprecate-legacy-interfaces---no-mbox-forward-and-alike"><a class="header" href="#deprecate-legacy-interfaces---no-mbox-forward-and-alike">Deprecate legacy interfaces - no mbox, .forward and alike</a></h2>
<blockquote>
<p>I think several of these errata help demonstrate that principles like
eliminating legacy interfaces and reducing complexity are vital to
maintaining security.</p>
</blockquote>
<p><a href="https://flak.tedunangst.com/post/rethinking-openbsd-security">rethinking openbsd security</a>
by Ted Unangst</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="simplicity"><a class="header" href="#simplicity">Simplicity</a></h1>
<p>Do not re-invent the wheel.</p>
<ul>
<li>Do one job - transfer mail. Transfer to MDAs and other SMTP servers</li>
<li>Do not orchestrate processes - offload this work to the OS service manager.</li>
<li>Don't do MDA's work - let MDA deliver messages to users. Hand the mail to MDA
via LMTP</li>
</ul>
<p>On the other hand, simplicity does not mean that things should be hard
to get to work -- quite the contrary. For example with the OS service
manager, with simple things built, it is possible to either use the OS
service manager to handle orchestration (the preferred solution), but
also to run a minimal wrapper that kannader provides. This is required
for the cases where the OS service manager has different abilities
than the one for which kannader was designed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-the-queue-works"><a class="header" href="#how-the-queue-works">How The Queue Works</a></h1>
<h2 id="high-level-overview"><a class="header" href="#high-level-overview">High-Level Overview</a></h2>
<p>Kannader, as a library design, supports any storage mechanism that can
implement the
<a href="https://ekleog.github.io/kannader/dev-doc/smtp_queue/trait.Storage.html"><code>Storage</code></a>
trait.</p>
<p>The core idea of this trait is, that each function must either
succeed or return an error for future retry.</p>
<p>The storage must provide basically three sets of primitives:</p>
<ul>
<li>For listing the emails that were left over from previous runs:
<ul>
<li><code>list_queue</code>, <code>find_inflight</code> and <code>find_pending_cleanup</code></li>
</ul>
</li>
<li>For queuing emails and reading them from the storage:
<ul>
<li><code>enqueue</code> and <code>read_inflight</code>, that both operate on
already-SMTP-encoded mails</li>
</ul>
</li>
<li>For handling state changes for each email:
<ul>
<li><code>reschedule</code></li>
<li><code>send_start</code>, <code>send_done</code> and <code>send_cancel</code></li>
<li><code>drop</code> and <code>cleanup</code></li>
</ul>
</li>
</ul>
<p>This being said, we do not expect system administrators to write their
own storage systems, unless they have very particular needs. As a
consequence, an implementation is provided with kannader, and bundled
in kannader the executable, that works with a local filesystem queue
like most other SMTP servers do by default.</p>
<h2 id="provided-implementation-queueing-with-the-local-filesystem"><a class="header" href="#provided-implementation-queueing-with-the-local-filesystem">Provided implementation: queueing with the local filesystem</a></h2>
<h3 id="file-structure"><a class="header" href="#file-structure">File Structure</a></h3>
<ul>
<li><code>&lt;queue&gt;/data</code>: location for the contents and metadata of the
emails in the queue</li>
<li><code>&lt;queue&gt;/queue</code>: folder for holding symlinks to the emails</li>
<li><code>&lt;queue&gt;/inflight</code>: folder for holding symlinks to the emails that
are currently in flight</li>
<li><code>&lt;queue&gt;/cleanup</code>: folder for holding symlinks to the emails that
are currently being deleted after being successfully sent</li>
</ul>
<p><code>&lt;queue&gt;/data</code> is the only directory that holds things that are not
symbolic links. All other folders only hold symbolic links that must
point into <code>&lt;queue&gt;/data</code> as relative links.</p>
<h3 id="assumptions"><a class="header" href="#assumptions">Assumptions</a></h3>
<ul>
<li>Moving a symlink to another folder is atomic between
<code>&lt;queue&gt;/queue</code>, <code>&lt;queue&gt;/inflight</code> and <code>&lt;queue&gt;/cleanup</code></li>
<li>Moving a file is atomic between files in the same <code>&lt;queue&gt;/data/**</code>
folder</li>
<li>Creating a symlink in the <code>&lt;queue&gt;/queue</code> folder is atomic</li>
<li>Once a write is flushed without error, it is guaranteed not to be
changed by something other than a kannader instance (or another
system aware of kannader's protocol and guarantees)</li>
</ul>
<h3 id="queuedata"><a class="header" href="#queuedata"><code>&lt;queue&gt;/data</code></a></h3>
<p>Each email in <code>&lt;queue&gt;/data</code> is a folder, that is constituted of:</p>
<ul>
<li><code>&lt;mail&gt;/contents</code>: the RFC5322 content of the email</li>
<li><code>&lt;mail&gt;/&lt;dest&gt;/metadata</code>: the JSON-encoded <code>MailMetadata&lt;U&gt;</code></li>
<li><code>&lt;mail&gt;/&lt;dest&gt;/schedule</code>: the JSON-encoded <code>ScheduleInfo</code> couple</li>
</ul>
<p>Both <code>&lt;mail&gt;/&lt;dest&gt;/metadata</code> and <code>&lt;mail&gt;/&lt;dest&gt;/schedule</code> could
change over time. In this case, the replacement gets written by
writing a <code>&lt;filename&gt;.{{random_uuid}}</code> then renaming it in-place.</p>
<h3 id="enqueuing-process"><a class="header" href="#enqueuing-process">Enqueuing Process</a></h3>
<p>When enqueuing, the process is:</p>
<ul>
<li>Create <code>&lt;queue&gt;/data/&lt;uuid&gt;</code>, thereafter named <code>&lt;mail&gt;</code></li>
<li>For each destination (ie. recipient email address):
<ul>
<li>Create <code>&lt;mail&gt;/&lt;uuid&gt;</code>, thereafter named <code>&lt;mail&gt;/&lt;dest&gt;</code></li>
<li>Write <code>&lt;mail&gt;/&lt;dest&gt;/schedule</code> and <code>&lt;mail&gt;/&lt;dest&gt;/metadata</code></li>
</ul>
</li>
<li>Give out the Enqueuer to the user for writing <code>&lt;mail&gt;/contents</code></li>
<li>Wait for the user to commit the Enqueuer</li>
<li>Create a symlink from <code>&lt;queue&gt;/queue/&lt;uuid&gt;</code> to <code>&lt;mail&gt;/&lt;dest&gt;</code> for
each destination</li>
</ul>
<h3 id="starting-and-cancelling-sends"><a class="header" href="#starting-and-cancelling-sends">Starting and Cancelling Sends</a></h3>
<p>When starting to send or cancelling a send, the process is:</p>
<ul>
<li>Move <code>&lt;queue&gt;/queue/&lt;id&gt;</code> to <code>&lt;queue&gt;/inflight/&lt;id&gt;</code> (or back)</li>
</ul>
<h3 id="cleaning-up"><a class="header" href="#cleaning-up">Cleaning Up</a></h3>
<p>When done with sending a mail and it thus needs to be removed from
disk, the process is:</p>
<ul>
<li>Move <code>&lt;queue&gt;/inflight/&lt;id&gt;</code> to <code>&lt;queue&gt;/cleanup/&lt;id&gt;</code></li>
<li>Remove <code>&lt;queue&gt;/cleanup/&lt;id&gt;/*</code> (which actually are in
<code>&lt;queue&gt;/data/&lt;mail&gt;/&lt;dest&gt;/*</code>)</li>
<li>Remove the target of <code>&lt;queue&gt;/cleanup/&lt;id&gt;</code> (the folder in
<code>&lt;queue&gt;/data/&lt;mail&gt;</code>)</li>
<li>Check whether only <code>&lt;queue&gt;/data/&lt;mail&gt;/contents</code> remains, and if
so remove it as well as the <code>&lt;queue&gt;/data/&lt;mail&gt;</code> folder</li>
<li>Remove the <code>&lt;queue&gt;/cleanup/&lt;id&gt;</code> symlink</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="community"><a class="header" href="#community">Community</a></h1>
<p>Kannader's community is currently mostly on IRC/Matrix. Feel free to drop by,
be it for asking questions, giving ideas, raising issues or just
saying hi!</p>
<p>The main channel is <code>#kannader</code> on <a href="https://libera.chat">libera.chat</a>.</p>
<p>Here are a few ways to join it:</p>
<ul>
<li>Join <code>#kannader:libera.chat</code> from <a href="https://matrix.org/">Matrix</a>, eg. using
<a href="https://app.element.io/#/room/#kannader:libera.chat">the online client</a>, or</li>
<li><a href="https://kiwiirc.com/nextclient/irc.libera.chat/#kannader">Use a temporary online
client</a>.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
